<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex, nofollow">
  <title>Studio</title>
  <link rel="stylesheet" href="../styles/theme.css">
  <style>
    .gate{ position:fixed; inset:0; display:grid; place-content:center; background:#fff; padding:22px }
    .panel{ width:min(420px, 92vw); border:1px solid var(--line); border-radius:12px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.06) }
    .code{ letter-spacing:.4em; font-size:28px; text-align:center; padding:10px 12px; border:1px solid #ddd; border-radius:8px; width:100% }
    .keys{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:14px }
    .btn{ padding:14px 0; border:1px solid #ddd; border-radius:10px; background:#fafafa; text-align:center; cursor:pointer; user-select:none }
    .btn:active{ background:#f0f0f0 }
    .row{ display:flex; gap:14px; margin-top:14px }
    .err{ color:#b00020; min-height:1.2em; margin-top:8px }
    .hint{ color:#888; font-size:12px; margin-top:10px }
  </style>
  <script>window.CMS_MANUAL_INIT = true;</script>
</head>
<body>
  <div class="gate" id="gate">
    <div class="panel">
      <h1 class="brand" style="margin:0 0 8px 0; font-size:28px">Studio Access</h1>
      <p class="caption" style="margin:0 0 14px 0">Enter your 6-digit code</p>
      <input id="code" class="code" inputmode="numeric" maxlength="6" autocomplete="one-time-code" aria-label="6-digit code" />
      <div class="keys" id="keys"></div>
      <div class="row">
        <button class="btn" id="clear" type="button">Clear</button>
        <button class="btn" id="del" type="button">Delete</button>
        <button class="btn" id="ok" type="button">OK</button>
      </div>
      <div class="err" id="err"></div>
      <div class="hint">For your protection, attempts are rate-limited.</div>
    </div>
  </div>

  <div id="cmsRoot" hidden></div>

  <!-- OAuth bridge: receive token and open Studio immediately -->
  <script>
    function cmsToken() {
      try {
        const a = localStorage.getItem('decap-cms-auth');
        if (a) return JSON.parse(a);
      } catch {}
      try {
        const b = localStorage.getItem('netlify-cms-user');
        if (b) {
          const t = JSON.parse(b).token;
          if (t) return { token: t, provider: 'github' };
        }
      } catch {}
      return null;
    }

    // When the popup sends us the token, persist and launch Studio (no reload loop)
    window.addEventListener('message', (e) => {
      try {
        if (typeof e.data === 'string' && e.data.startsWith('authorization:github:success:')) {
          const json = e.data.slice('authorization:github:success:'.length);
          const payload = JSON.parse(json); // { token, provider: "github" }
          localStorage.setItem('decap-cms-auth', JSON.stringify(payload));
          localStorage.setItem('netlify-cms-user', JSON.stringify({ token: payload.token, provider: 'github' }));
          openStudio(); // go straight in
        }
      } catch (_) {}
    });
  </script>

  <script>
    // ======= GATE CONFIG =======
    const SALT = "Passionforart";
    // sha256("Passionforart" + "959595")
    const HASH_HEX = "b0ec7878d817c32506a98c03178f6c4cb88866d6862fb5a33fbe1c81b0483c46";

    async function sha256hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function rateKey(){ return 'studio_attempts_'+new Date().toISOString().slice(0,10); }

    const codeEl = document.getElementById('code');
    const keysEl = document.getElementById('keys');
    const errEl  = document.getElementById('err');
    const gate   = document.getElementById('gate');
    const cmsRoot= document.getElementById('cmsRoot');
    const okBtn  = document.getElementById('ok');

    // keypad
    [...'1234567890'].forEach(d=>{
      const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=d;
      b.addEventListener('click', ()=>{ if(codeEl.value.length<6) codeEl.value+=d; });
      if(d==='0'){ const s1=document.createElement('div'); s1.style.visibility='hidden';
                   const s2=document.createElement('div'); s2.style.visibility='hidden';
                   keysEl.append(s1,b,s2); }
      else keysEl.appendChild(b);
    });
    document.getElementById('clear').onclick = ()=> codeEl.value='';
    document.getElementById('del').onclick   = ()=> codeEl.value=codeEl.value.slice(0,-1);
    okBtn.onclick = verify;
    codeEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); okBtn.click(); }
      if(!/^\d$/.test(e.key) && !['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Enter'].includes(e.key)) e.preventDefault();
    });

    function attempts(){ return parseInt(localStorage.getItem(rateKey())||'0',10); }
    function bump(){ localStorage.setItem(rateKey(), String(attempts()+1)); }

    async function verify(){
      errEl.textContent='';
      if (attempts()>=12) { errEl.textContent='Too many attempts today. Try again tomorrow.'; return; }
      if (codeEl.value.length!==6) { errEl.textContent='Enter all 6 digits.'; return; }
      const candidate = await sha256hex(SALT + codeEl.value);
      if (candidate === HASH_HEX) openStudio();
      else { bump(); errEl.textContent='Incorrect code.'; codeEl.value=''; }
    }

    function openStudio(){
      if (window.__cmsBooted) return;
      window.__cmsBooted = true;

      // IMPORTANT: do NOT clear the stored tokens (that caused the loop).
      // Only clear old identity artifacts if present.
      try {
        Object.keys(localStorage).forEach(k=>{
          if (/netlify-identity|git-gateway/i.test(k)) localStorage.removeItem(k);
        });
        Object.keys(sessionStorage).forEach(k=>{
          if (/netlify-identity|git-gateway/i.test(k)) sessionStorage.removeItem(k);
        });
      } catch {}

      gate.remove();
      cmsRoot.hidden=false;

      const s = document.createElement('script');
      s.id = 'decapScript';
      s.src = "https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js";
      s.onload = () => {
        window.CMS.init({
          load_config_file: false, // inline config
          config: {
            backend: {
              name: "github",
              repo: "robbie-likescodes/Tessa-Bennion-s-Art-Page",
              branch: "main",
              base_url: "https://project-gbxs8.vercel.app",
              auth_endpoint: "api/auth"
            },
            media_folder: "uploads",
            public_folder: "uploads",
            publish_mode: "editorial_workflow",
            collections: [
              {
                name: "works",
                label: "Works",
                folder: "content/works",
                create: true,
                slug: "{{year}}-{{slug}}",
                editor: { preview: false },
                fields: [
                  { label: "Title", name: "title", widget: "string" },
                  { label: "Year",  name: "year",  widget: "number" },
                  { label: "Medium", name: "medium", widget: "string" },
                  { label: "Dimensions", name: "dimensions", widget: "string" },
                  { label: "Cover Image", name: "cover", widget: "image" },
                  { label: "Gallery", name: "images", widget: "list",
                    field: { label: "Image", name: "image", widget: "image" } },
                  { label: "Description", name: "body", widget: "markdown", required: false },
                  { label: "Tags", name: "tags", widget: "list", required: false }
                ]
              }
            ]
          }
        });
        console.log('Decap CMS loaded (GitHub backend via Vercel OAuth proxy)');
      };
      document.body.appendChild(s);
    }

    // ---- Auto-bypass keypad if token already exists (prevents loop) ----
    (function autoBypass(){
      if (cmsToken()) openStudio();
    })();
  </script>
</body>
</html>
